<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BNI 신경-기능 지수 테스트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f7f7f9; color:#111;
    }
    .card{
      max-width:760px; margin:0 auto;
      background:#fff; border:1px solid #e6e8ef;
      border-radius:12px; padding:18px;
      box-shadow:0 2px 10px rgba(0,0,0,0.04);
    }
    h1{margin:0 0 8px; font-size:1.2rem}
    .sub{color:#555; font-size:0.92rem; line-height:1.4; margin:0 0 14px}
    .badge{
      display:inline-block; font-size:0.78rem;
      padding:4px 10px; border-radius:999px;
      background:#eef3ff; color:#1a73e8; margin-bottom:10px;
    }
    fieldset{
      border:1px solid #ddd; border-radius:10px;
      padding:12px; margin:10px 0; background:#fff;
    }
    legend{font-weight:700}
    .q{
      padding:10px 0; border-bottom:1px dashed #eee;
    }
    .q:last-child{border-bottom:none}
    .qt{font-weight:600; margin:0 0 6px; line-height:1.35}
    .opt{display:flex; gap:14px; flex-wrap:wrap; font-size:0.92rem}
    .opt label{display:inline-flex; align-items:center; gap:6px}
    button{
      cursor:pointer;
      padding:11px 16px; border-radius:999px;
      border:1px solid #1a73e8; background:#1a73e8; color:#fff;
      font-weight:700; font-size:0.95rem;
    }
    button.ghost{
      background:#fff; color:#1a73e8;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .result{
      margin-top:14px; padding:14px;
      border-radius:12px; border:1px solid #e6e8ef;
      background:#fafbff;
    }
    .big{font-size:1.05rem; font-weight:800; margin:0 0 6px}
    .muted{color:#555; font-size:0.9rem; margin:0}
    .codebox{
      width:100%; min-height:110px; margin-top:10px;
      padding:10px; border-radius:10px; border:1px solid #ddd;
      font-size:0.9rem; white-space:pre-wrap;
    }
    .warn{color:#b00020; font-size:0.86rem; margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <div class="badge">무료 · 익명 · 45초</div>
    <h1>BNI 신경-기능 지수 테스트</h1>
    <p class="sub">
      아래 문항은 “신경·자율신경·수면·소화·통증 패턴”을 빠르게 점수화합니다.<br>
      <strong>결과는 진단이 아니라, 정밀문진으로 넘어갈지 판단하는 지표</strong>입니다.
    </p>

    <form id="bniForm">
      <fieldset>
        <legend>문항 (예/아니오)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="row">
        <button type="button" onclick="calcBNI()">BNI 결과 보기</button>
        <button type="button" class="ghost" onclick="resetBNI()">초기화</button>
      </div>

      <div id="result" class="result" style="display:none;">
        <p class="big" id="headline"></p>
        <p class="muted" id="desc"></p>

        <textarea id="codebox" class="codebox" readonly></textarea>

        <div class="row">
          <button type="button" onclick="copyCode()">결과코드 복사</button>
          <button type="button" class="ghost" onclick="goM2()">정밀문진(m2)로 이동</button>
        </div>

        <p class="warn" id="warn"></p>
      </div>
    </form>
  </div>

  <script>
    // ✅ m2 페이지 경로(원장님 환경에 맞게 유지)
    const M2_URL = "https://bodyallhani.github.io/herbmed0/m2.html";

    // ✅ 문항: 핵심만 20개(운영/이탈 최소화)
    // 가중치: 1(경도) / 2(중요) / 3(핵심)
    const ITEMS = [
      {id:"q1",  w:3, t:"MRI/검사는 큰 이상이 없는데 통증·불편이 계속된다"},
      {id:"q2",  w:3, t:"통증이 특정 자세/시간대에 반복적으로 올라온다(주기성/패턴)"},
      {id:"q3",  w:2, t:"잠들기 어렵거나, 자주 깨거나, 꿈이 많다"},
      {id:"q4",  w:2, t:"아침에 자도 잔 느낌이 없고, 몸이 무겁다"},
      {id:"q5",  w:2, t:"식후 더부룩함/소화지연이 자주 있다"},
      {id:"q6",  w:2, t:"스트레스 받으면 소화·통증·수면이 같이 무너진다"},
      {id:"q7",  w:2, t:"가슴 답답/한숨/숨이 짧은 느낌이 자주 있다"},
      {id:"q8",  w:2, t:"두근거림/심계/불안감이 동반된다"},
      {id:"q9",  w:1, t:"손발이 차거나(또는 확 뜨거워지거나) 체온감이 불안정하다"},
      {id:"q10", w:1, t:"땀이 많거나(또는 식은땀), 땀 패턴이 이상하다"},
      {id:"q11", w:2, t:"어지럼/띵함/기립 시 핑 도는 느낌이 있다"},
      {id:"q12", w:2, t:"손발 저림/감각이상/찌릿함이 있다"},
      {id:"q13", w:2, t:"소리/빛/냄새에 예민해져 피로가 빨리 온다"},
      {id:"q14", w:3, t:"같은 부위를 반복해서 삐끗하거나 담이 잘 온다"},
      {id:"q15", w:2, t:"목·어깨·등·허리 중 2곳 이상이 같이 불편하다(연동)"},
      {id:"q16", w:2, t:"운동을 하면 낫기보다 오히려 컨디션이 깨지는 경우가 있다"},
      {id:"q17", w:1, t:"대변이 일정치 않다(변비↔설사, 덜 나온 느낌, 토막변 등)"},
      {id:"q18", w:1, t:"카페인/술/야식 후 증상이 확 악화된다"},
      {id:"q19", w:2, t:"여러 병원·치료를 해도 뚜렷한 해답을 못 찾았다"},
      {id:"q20", w:2, t:"요즘 전반적으로 ‘몸이 예민해진 느낌’이 강하다"}
    ];

    function renderQuestions(){
      const wrap = document.getElementById("questions");
      wrap.innerHTML = ITEMS.map((it, idx)=>`
        <div class="q">
          <p class="qt">${idx+1}. ${it.t}</p>
          <div class="opt">
            <label><input type="radio" name="${it.id}" value="Y"> 예</label>
            <label><input type="radio" name="${it.id}" value="N"> 아니오</label>
          </div>
        </div>
      `).join("");
    }

    function getAnswer(id){
      const els = document.querySelectorAll(`input[name="${id}"]`);
      for(const e of els) if(e.checked) return e.value;
      return "";
    }

    function calcBNI(){
      // 미응답 체크
      const missing = [];
      let raw = 0;
      let max = 0;
      for(const it of ITEMS){
        max += it.w;
        const a = getAnswer(it.id);
        if(!a) missing.push(it.id);
        if(a === "Y") raw += it.w;
      }

      const resBox = document.getElementById("result");
      const warn = document.getElementById("warn");

      if(missing.length > 0){
        resBox.style.display = "block";
        warn.textContent = "⚠️ 아직 답변하지 않은 문항이 있습니다. 비워도 되지만, 점수 신뢰도가 떨어집니다.";
      } else {
        warn.textContent = "";
      }

      // 0~100 스케일
      const score = Math.round((raw / max) * 100);

      // 구간
      let tier = "";
      let label = "";
      let msg = "";
      if(score <= 24){
        tier = "GREEN";
        label = "BNI-안정군";
        msg = "현재 입력 기준으로는 신경기능 저하 신호가 상대적으로 약합니다. 다만 ‘패턴/반복’이 있으면 정밀문진을 권합니다.";
      } else if(score <= 49){
        tier = "YELLOW";
        label = "BNI-주의군";
        msg = "자율신경·수면·소화·통증이 함께 흔들릴 가능성이 있습니다. 정밀문진으로 ‘핵심 트리거’와 패턴을 잡는 게 유리합니다.";
      } else if(score <= 74){
        tier = "ORANGE";
        label = "BNI-고위험군";
        msg = "기능 저하 신호가 다수 겹칩니다. 정밀문진에서 ‘연동축(수면-소화-통증)’을 우선 확인하는 게 효율적입니다.";
      } else {
        tier = "RED";
        label = "BNI-고위험군+";
        msg = "여러 축이 동시에 무너진 패턴일 수 있습니다. 정밀문진을 통해 우선순위를 정리해야 시간/비용 낭비를 줄일 수 있습니다.";
      }

      // 코드 생성(간단/추적용)
      const code = makeCode(score, tier);

      // 화면 출력
      document.getElementById("headline").textContent = `${label} · ${score}점`;
      document.getElementById("desc").textContent = msg;

      const text =
`[BNI 결과] ${score}점 / ${label} / 코드: ${code}
(참고) 이 결과는 진단이 아니라 ‘정밀문진으로 넘어갈지’ 판단하는 지표입니다.`;

      document.getElementById("codebox").value = text;

      // 다음 페이지로 넘길 값 저장(세션)
      const payload = { score, label, code, tier, ts: Date.now() };
      try{ localStorage.setItem("BNI_PAYLOAD", JSON.stringify(payload)); }catch(e){}

      resBox.style.display = "block";
      window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
    }

    function makeCode(score, tier){
      // BNI-<tierShort><score>-<rand>
      const t = (tier || "X").slice(0,1);
      const r = Math.random().toString(36).slice(2,6).toUpperCase();
      return `BNI-${t}${String(score).padStart(2,"0")}-${r}`;
    }

    function copyCode(){
      const t = document.getElementById("codebox").value || "";
      if(!t){ alert("먼저 결과를 생성해주세요."); return; }
      copyText(t);
      alert("BNI 결과가 복사되었습니다.");
    }

    function goM2(){
      // URL 파라미터로도 전달 + localStorage 백업
      let payload = null;
      try{ payload = JSON.parse(localStorage.getItem("BNI_PAYLOAD")||"null"); }catch(e){}
      if(!payload){
        alert("결과가 없습니다. 먼저 BNI 결과를 생성해주세요.");
        return;
      }
      const qs = new URLSearchParams({
        bni_score: String(payload.score),
        bni_label: payload.label,
        bni_code: payload.code
      }).toString();
      window.location.href = M2_URL + "?" + qs;
    }

    function resetBNI(){
      document.getElementById("result").style.display = "none";
      document.getElementById("codebox").value = "";
      const radios = document.querySelectorAll("input[type=radio]");
      radios.forEach(r=>r.checked=false);
      try{ localStorage.removeItem("BNI_PAYLOAD"); }catch(e){}
      window.scrollTo({ top: 0, behavior:"smooth" });
    }

    function copyText(text){
      const temp = document.createElement("textarea");
      temp.style.position = "fixed";
      temp.style.opacity = "0";
      temp.value = text;
      document.body.appendChild(temp);
      temp.focus();
      temp.select();
      try { document.execCommand("copy"); }
      catch(e){
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).catch(function(){});
        }
      }
      document.body.removeChild(temp);
    }

    renderQuestions();
  </script>
</body>
</html>
