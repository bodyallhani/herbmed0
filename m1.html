<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BNI 신경-기능 지수 테스트 (m1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      max-width:900px;margin:0 auto;padding:16px;line-height:1.5;
      background:#f7f7f9;color:#111;
    }
    h1{margin:8px 0 6px;font-size:1.35rem}
    .sub{color:#555;font-size:0.92rem;margin:0 0 14px}
    .card{
      background:#fff;border:1px solid #e0e3ec;border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.04);padding:14px;margin-top:12px;
    }
    .badge{
      display:inline-block;font-size:0.78rem;padding:4px 8px;border-radius:999px;
      background:#e8f0fe;color:#1a73e8;font-weight:700;margin-bottom:8px;
    }
    .hint{color:#666;font-size:0.85rem;margin:8px 0 0}
    .q{
      padding:12px;border:1px solid #d9deea;border-radius:12px;background:#fff;
      margin:12px 0;
    }
    .qtitle{font-weight:800;margin-bottom:10px}
    .opts{
      display:flex;flex-direction:column;gap:8px;
      padding-top:2px;
    }
    .opt{
      display:flex;align-items:center;gap:8px;
      padding:10px 10px;border:1px solid #e5e9f3;border-radius:10px;
      background:#fafbff;
    }
    .opt input{transform:scale(1.15)}
    .row{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;
    }
    button{
      padding:12px 14px;border-radius:10px;border:1px solid #888;background:#fff;
      cursor:pointer;font-weight:700;
    }
    button.primary{
      background:#1a73e8;color:#fff;border-color:#1a73e8;
    }
    button:disabled{opacity:0.6;cursor:not-allowed}
    .err{color:#b00020;font-weight:700;margin-top:10px}
    /* 결과 패널(검은 배경) */
    .result{
      background:#0b0f1a;color:#e9edf7;border-radius:14px;
      padding:14px;border:1px solid rgba(255,255,255,0.08);
    }
    .result .big{font-size:1.15rem;font-weight:900}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hr{height:1px;background:rgba(255,255,255,0.12);margin:10px 0}
    /* 계산중 오버레이 */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.72);
      display:none;align-items:center;justify-content:center;z-index:9999;
      padding:16px;
    }
    .overlay.on{display:flex}
    .overlay-box{
      width:min(420px,100%);background:#0b0f1a;color:#e9edf7;
      border:1px solid rgba(255,255,255,0.12);border-radius:14px;
      padding:16px 14px;
    }
    .spinner{
      width:22px;height:22px;border-radius:50%;
      border:3px solid rgba(255,255,255,0.18);
      border-top-color:#fff;animation:spin 0.9s linear infinite;
      margin-right:10px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .calc-row{display:flex;align-items:center;gap:10px}
    .calc-title{font-weight:900}
    .calc-sub{font-size:0.9rem;color:#b9c2da;margin-top:6px}
    .hidden{display:none}
  </style>
</head>
<body>

  <h1>BNI 신경-기능 지수 테스트 (m1)</h1>
  <p class="sub">익명 · 60초 · 결과 즉시 확인 → 원하시면 정밀문진(m2)로 연결됩니다.</p>

  <div class="card">
    <div class="badge">응답 방식</div>
    <div class="hint">
      각 문항에 대해 아래 5단계로 선택해 주세요.<br>
      (전혀 아니다 / 아니다 / 보통 / 그렇다 / 매우 그렇다)
    </div>
  </div>

  <form id="bniForm">

    <!-- 문항 12개 예시 (원장님이 원하시면 더 늘려서 AH까지 확장 가능) -->
    <div class="q" data-q="Q01">
      <div class="qtitle">1. 검사상 큰 이상이 없다고 들었는데도, 불편감(통증/저림/답답함)이 계속됩니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q01" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q01" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q01" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q01" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q01" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q02">
      <div class="qtitle">2. 스트레스가 있으면 증상이 바로 악화되거나, 몸이 급격히 예민해집니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q02" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q02" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q02" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q02" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q02" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q03">
      <div class="qtitle">3. 잠이 얕거나(중간 각성/꿈 많음), 자고 일어나도 회복이 잘 안 됩니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q03" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q03" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q03" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q03" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q03" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q04">
      <div class="qtitle">4. 소화가 쉽게 무너지거나(더부룩/체함/속쓰림), 식후 컨디션이 뚝 떨어집니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q04" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q04" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q04" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q04" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q04" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q05">
      <div class="qtitle">5. 가슴 답답함/숨이 짧음/한숨이 잦음 같은 호흡 불편이 있습니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q05" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q05" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q05" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q05" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q05" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q06">
      <div class="qtitle">6. 두근거림/불안/초조가 이유 없이 올라오거나, 사람 많은 곳에서 더 심해집니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q06" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q06" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q06" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q06" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q06" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q07">
      <div class="qtitle">7. 손발이 차거나 뜨거운 느낌이 자주 변하고, 체온/날씨 변화에 민감합니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q07" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q07" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q07" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q07" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q07" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q08">
      <div class="qtitle">8. 어지럼/기립 시 불편(핑 도는 느낌)이 자주 있거나, 쉽게 지칩니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q08" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q08" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q08" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q08" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q08" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q09">
      <div class="qtitle">9. 근육 문제처럼 보여도, 같은 부위가 반복적으로 삐끗하거나 통증이 재발합니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q09" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q09" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q09" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q09" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q09" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q10">
      <div class="qtitle">10. 소리/빛/냄새 같은 자극에 예민하거나, 긴장하면 몸이 바로 굳습니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q10" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q10" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q10" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q10" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q10" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q11">
      <div class="qtitle">11. 땀이 이상하게 나거나(식은땀/긴장 시 땀), 피로가 쌓이면 더 심해집니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q11" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q11" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q11" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q11" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q11" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="q" data-q="Q12">
      <div class="qtitle">12. 한 가지 치료로는 잘 해결되지 않고, 여러 증상이 같이 엮여 움직이는 느낌입니다.</div>
      <div class="opts">
        <label class="opt"><input type="radio" name="Q12" value="0"> 전혀 아니다</label>
        <label class="opt"><input type="radio" name="Q12" value="1"> 아니다</label>
        <label class="opt"><input type="radio" name="Q12" value="2"> 보통</label>
        <label class="opt"><input type="radio" name="Q12" value="3"> 그렇다</label>
        <label class="opt"><input type="radio" name="Q12" value="4"> 매우 그렇다</label>
      </div>
    </div>

    <div class="row">
      <button type="button" class="primary" id="calcBtn">BNI 결과 계산하기</button>
      <button type="reset" id="resetBtn">초기화</button>
    </div>
    <div id="err" class="err hidden">모든 문항에 응답해 주세요.</div>

  </form>

  <div id="resultWrap" class="card hidden">
    <div class="badge">결과</div>
    <div class="result">
      <div class="big" id="resTitle">BNI 결과</div>
      <div class="hr"></div>
      <div id="resBody" class="mono"></div>
      <div class="hr"></div>

      <div style="font-weight:800;margin-bottom:6px">정밀 문진으로 이어서 분석하기</div>
      <div class="hint" style="color:#b9c2da;margin:0 0 10px">
        좀 더 정확한 분석을 원하신다면, 정밀문진(m2)을 시작해 보세요.
      </div>
      <button type="button" class="primary" id="goM2Btn">정밀 문진 시작하기</button>
    </div>
  </div>

  <!-- 계산중 오버레이 -->
  <div class="overlay" id="overlay">
    <div class="overlay-box">
      <div class="calc-row">
        <div class="spinner"></div>
        <div>
          <div class="calc-title">분석중…</div>
          <div class="calc-sub">입력하신 증상 패턴을 신경-기능 지수로 변환하고 있습니다.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ✅ m1 Apps Script URL (원장님이 준 URL)
    const FORM_ENDPOINT_M1 = "https://script.google.com/macros/s/AKfycbzWPBIq7vJPL_9ADgmGGn-9ql9i3H25hk94QLnKtB-g9kgd10iNPx8JDEOQDIV8tAUy8g/exec";

    // ✅ m2 경로(같은 레포/폴더)
    const M2_URL = "m2.html";

    const overlay = document.getElementById("overlay");
    const calcBtn = document.getElementById("calcBtn");
    const goM2Btn = document.getElementById("goM2Btn");
    const errBox = document.getElementById("err");
    const resultWrap = document.getElementById("resultWrap");
    const resTitle = document.getElementById("resTitle");
    const resBody = document.getElementById("resBody");

    let lastPayload = null;

    function showOverlay(on){
      overlay.classList.toggle("on", !!on);
    }
    function showErr(msg){
      errBox.textContent = msg || "모든 문항에 응답해 주세요.";
      errBox.classList.remove("hidden");
    }
    function hideErr(){
      errBox.classList.add("hidden");
    }

    function getAnswers(){
      const qEls = document.querySelectorAll(".q");
      const ans = {};
      for(const q of qEls){
        const qid = q.getAttribute("data-q");
        const checked = document.querySelector(`input[name="${qid}"]:checked`);
        if(!checked) return null;
        ans[qid] = Number(checked.value);
      }
      return ans;
    }

    function sumScore(ans){
      // 0~4 * 12문항 = 0~48
      let s = 0;
      Object.keys(ans).forEach(k => s += (ans[k] || 0));
      return s;
    }

    function to100(raw, maxRaw){
      // 0~maxRaw -> 0~100
      return Math.round((raw / maxRaw) * 100);
    }

    function labelByScore(score100){
      // 원장님 운영 기준에 맞춰 조정 가능
      if(score100 >= 75) return "상위 위험군(RED)";
      if(score100 >= 50) return "고위험군(ORANGE)";
      if(score100 >= 25) return "주의군(YELLOW)";
      return "안정군(GREEN)";
    }

    function codeByAnswers(ans){
      // 간단 코드: 상위 축(수면/소화/자율신경/통증) 강도 기반
      // Q03(수면), Q04(소화), Q06/Q07/Q11(자율), Q09(통증/재발)
      const sleep = ans.Q03;
      const digest = ans.Q04;
      const autoN = Math.round((ans.Q06 + ans.Q07 + ans.Q11)/3);
      const msk = ans.Q09;

      // 0~4를 A~E로 매핑(시각적 코드)
      const map = ["A","B","C","D","E"]; // A=0 ... E=4
      return `S${map[sleep]}-D${map[digest]}-A${map[autoN]}-M${map[msk]}`;
    }

    // ✅ m1 응답을 시트로 전송(POST + GET 비콘 백업)
    function sendM1ToSheet(payload){
      // 1) POST
      try{
        const body = new URLSearchParams(payload).toString();
        fetch(FORM_ENDPOINT_M1, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        }).catch(()=>{});
      }catch(e){}

      // 2) GET 비콘(백업)
      try{
        const qs = new URLSearchParams(payload).toString();
        const img = new Image();
        img.src = FORM_ENDPOINT_M1 + "?" + qs;
      }catch(e){}
    }

    function buildResultText(p){
      // 검은 화면에 보여줄 텍스트(사용자용)
      const lines = [];
      lines.push(`[BNI 점수] ${p.score}점`);
      lines.push(`[분류] ${p.label}`);
      lines.push(`[코드] ${p.code}`);
      lines.push("");
      lines.push("※ 이 결과는 '진단'이 아니라,");
      lines.push("  신경-기능 패턴을 빠르게 요약한 지수입니다.");
      return lines.join("\n");
    }

    function persistPayload(p){
      try{
        localStorage.setItem("BNI_PAYLOAD", JSON.stringify(p));
      }catch(e){}
    }

    function buildM2Link(p){
      const qs = new URLSearchParams({
        bni_score: String(p.score),
        bni_label: String(p.label),
        bni_code:  String(p.code)
      }).toString();
      return M2_URL + "?" + qs;
    }

    calcBtn.addEventListener("click", function(){
      hideErr();
      const ans = getAnswers();
      if(!ans){
        showErr("모든 문항에 응답해 주세요.");
        return;
      }

      // “정밀해 보이는” 계산중 연출
      showOverlay(true);
      calcBtn.disabled = true;

      setTimeout(() => {
        const raw = sumScore(ans);
        const maxRaw = 48;
        const score100 = to100(raw, maxRaw);
        const label = labelByScore(score100);
        const code = codeByAnswers(ans);

        const payload = {
          stage: "m1",
          submitted_at: new Date().toISOString(),
          bni_score: String(score100),
          bni_label: String(label),
          bni_code:  String(code),
          // 필요하면 원시응답 저장(앱스크립트가 허용하면 시트에 같이 남습니다)
          raw_answers: JSON.stringify(ans)
        };

        lastPayload = { score: score100, label, code };

        // 시트 저장
        sendM1ToSheet(payload);

        // m2 자동분기용 저장
        persistPayload(lastPayload);

        // 결과 UI
        resTitle.textContent = "BNI 결과(즉시)";
        resBody.textContent = buildResultText(lastPayload);
        resultWrap.classList.remove("hidden");

        showOverlay(false);
        calcBtn.disabled = false;

        // 결과로 스크롤
        resultWrap.scrollIntoView({behavior:"smooth", block:"start"});
      }, 1200); // 1.2초 정도가 “계산중” 느낌에 가장 무난
    });

    goM2Btn.addEventListener("click", function(){
      if(!lastPayload){
        // 혹시 결과 없이 눌렀을 때
        showErr("먼저 BNI 결과를 계산해 주세요.");
        return;
      }
      const url = buildM2Link(lastPayload);
      window.location.href = url;
    });

    // 초기화 시 결과 숨김
    document.getElementById("resetBtn").addEventListener("click", function(){
      resultWrap.classList.add("hidden");
      hideErr();
      lastPayload = null;
      try{ localStorage.removeItem("BNI_PAYLOAD"); }catch(e){}
    });
  </script>

</body>
</html>
