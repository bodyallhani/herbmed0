<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BNI 신경-기능 테스트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body{
      margin:0; padding:16px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f6f7fb; color:#111;
      line-height:1.5;
      max-width:820px; margin:0 auto;
    }
    h1{ font-size:1.2rem; margin:6px 0 10px; }
    .sub{ color:#555; font-size:.92rem; margin:0 0 14px; }
    .card{
      background:#fff; border:1px solid #e3e6f2;
      border-radius:12px; padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
      margin-bottom:12px;
    }
    .badge{
      display:inline-block;
      font-size:.78rem;
      padding:4px 8px;
      border-radius:999px;
      background:#e8f0fe;
      color:#1a73e8;
      margin-bottom:8px;
      font-weight:600;
    }
    .q{
      padding:12px;
      border:1px solid #e7eaf6;
      border-radius:12px;
      background:#fff;
      margin:0 0 12px;
    }
    .q-title{
      font-weight:700;
      margin:0 0 10px;
      font-size:1.02rem;
    }
    .q-desc{
      margin:6px 0 0;
      color:#555;
      font-size:.86rem;
    }

    /* ✅ 모바일에서 5점 항목이 "세로로" 쭉 정리되도록 */
    .options{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
      padding-top:6px;
      border-top:1px dashed #e2e6f3;
    }
    .opt{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #e7eaf6;
      border-radius:10px;
      background:#fafbff;
      font-size:.95rem;
    }
    .opt input{ transform:scale(1.1); }

    /* 큰 화면에서는 2열로 */
    @media (min-width: 720px){
      .options{ flex-direction:row; flex-wrap:wrap; }
      .opt{ width: calc(50% - 6px); }
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:1px solid #cfd6ea;
      background:#fff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background:#1a73e8;
      border-color:#1a73e8;
      color:#fff;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .result{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#0b1020;
      color:#e8ecff;
      border-radius:12px;
      padding:12px;
      font-size:.9rem;
      overflow:auto;
      min-height:140px;
    }

    .hint{
      color:#666;
      font-size:.85rem;
      margin:8px 0 0;
    }

    .mini{
      font-size:.88rem; color:#444;
      margin:8px 0 0;
    }
    .divider{ height:1px; background:#e7eaf6; margin:10px 0; }

    select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d7deef;
      background:#fff;
      font-size:.95rem;
    }
    .warn{
      color:#b00020;
      font-weight:800;
      margin:10px 0 0;
      display:none;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="badge">무료 · 익명 · 1~2분</div>
    <h1>BNI 1차 지수 테스트</h1>
    <p class="sub">
      “문진표”가 아니라 <strong>현재 상태를 수치로 보는</strong> 1차 스크리닝입니다.<br>
      아래 25문항은 모두 객관식이며, <strong>높을수록(점수↑) 기능부하 가능성↑</strong>입니다.
    </p>
    <p class="sub" style="margin-bottom:0;">
      응답 기준: <strong>최근 2주</strong>를 떠올리고 선택하세요.
    </p>
  </div>

  <!-- ✅ 참고용(비점수) 문항: MRI/검사 전제 필요 -->
  <div class="q">
    <div class="q-title">참고 질문 (점수에 포함되지 않음)</div>

    <div class="mini"><strong>Q0-1.</strong> 최근 2년 내에 MRI/CT/X-ray 등 검사를 받아본 적이 있나요?</div>
    <select id="ref_imaging">
      <option value="">선택</option>
      <option value="YES">예</option>
      <option value="NO">아니오</option>
      <option value="UNK">모르겠음</option>
    </select>

    <div class="mini"><strong>Q0-2.</strong> (검사를 했다면) “큰 이상은 없다/수술할 정도는 아니다” 같은 설명을 들은 적이 있나요?</div>
    <select id="ref_normal">
      <option value="">선택</option>
      <option value="YES">예</option>
      <option value="NO">아니오</option>
      <option value="UNK">모르겠음</option>
      <option value="NA">해당없음(검사 안 함)</option>
    </select>

    <div class="mini"><strong>Q0-3.</strong> 현재 증상 때문에 약(양약/한약 포함)을 복용 중인가요?</div>
    <select id="ref_meds">
      <option value="">선택</option>
      <option value="YES">예</option>
      <option value="NO">아니오</option>
      <option value="UNK">모르겠음</option>
    </select>

    <p class="hint">※ 위 3개는 ‘전제가 필요한 문항’이라 점수 계산에 넣지 않습니다.</p>
  </div>

  <div id="questions"></div>

  <div class="card">
    <div class="row">
      <button class="btn primary" id="calcBtn">점수 계산하기</button>
      <button class="btn" id="resetBtn" type="button">초기화</button>
      <button class="btn" id="copyBtn" type="button">결과 복사</button>
    </div>
    <p class="warn" id="warnText">⚠️ 25문항 중 응답하지 않은 항목이 있습니다. 빈 문항을 채워주세요.</p>
    <div class="divider"></div>
    <div id="result" class="result">아직 계산 전입니다.</div>
    <p class="hint">
      계산 후 “정밀 문진(m2)”로 이어지도록 링크가 생성됩니다.
    </p>
  </div>

<script>
  // ✅ 5점 척도 라벨
  const LIKERT = [
    { label: "전혀 아니다", value: 0 },
    { label: "아니다", value: 1 },
    { label: "보통", value: 2 },
    { label: "그렇다", value: 3 },
    { label: "매우 그렇다", value: 4 },
  ];

  // ✅ 25개 점수문항 (문구: “답하기 편하게” 전제 제거/구체화)
  // 모든 문항은 "점수↑ = 문제 가능성↑" 방향으로 통일
  const ITEMS = [
    // PAIN / MSK (P)
    { id:"q1",  dom:"P", text:"통증/불편이 2주 이상 지속되거나, 좋아졌다가 다시 반복된다." },
    { id:"q2",  dom:"P", text:"특정 자세/동작(오래 앉기, 서기, 걷기, 숙이기 등)에서 증상이 확실히 악화된다." },
    { id:"q3",  dom:"P", text:"아침에 일어날 때 몸이 뻣뻣하거나, 움직이기까지 시간이 걸린다." },
    { id:"q4",  dom:"P", text:"같은 부위를 자주 삐끗하거나, ‘늘 그 자리’가 반복해서 문제 된다." },
    { id:"q5",  dom:"P", text:"저림/찌릿함/감각이상(손발, 팔, 다리)이 자주 있거나, 자세에 따라 달라진다." },

    // NEURO / AUTONOMIC (A)
    { id:"q6",  dom:"A", text:"어지럼/멍함/핑 도는 느낌이 자주 있다(특히 일어설 때 포함)." },
    { id:"q7",  dom:"A", text:"가슴 두근거림/맥박이 갑자기 빨라짐을 느끼는 일이 있다." },
    { id:"q8",  dom:"A", text:"숨이 얕아지거나 가슴이 답답해 ‘한숨/깊은숨’을 자주 쉬게 된다." },
    { id:"q9",  dom:"A", text:"불안/초조/예민함이 쉽게 올라오고, 진정이 잘 안 된다." },
    { id:"q10", dom:"A", text:"집중이 잘 안 되거나 ‘머리가 안 돌아가는 느낌(브레인포그)’이 있다." },

    // FATIGUE / ENERGY (E)
    { id:"q11", dom:"E", text:"피로가 쉽게 쌓이고, 쉬어도 회복이 느리다." },
    { id:"q12", dom:"E", text:"기운이 떨어져 ‘일상 수행능력’이 예전보다 확실히 줄었다." },

    // SLEEP (S)
    { id:"q13", dom:"S", text:"잠들기까지 30분 이상 걸리는 날이 잦다." },
    { id:"q14", dom:"S", text:"밤중에 자주 깨거나, 꿈이 많아 깊게 잔 느낌이 적다." },
    { id:"q15", dom:"S", text:"아침에 일어나도 개운하지 않고, 몸이 무겁다." },

    // DIGESTION (D)
    { id:"q16", dom:"D", text:"식욕이 불안정하다(입맛 없음/갑자기 과식/들쭉날쭉)." },
    { id:"q17", dom:"D", text:"식후 더부룩함/가스/복부 팽만이 자주 있다." },
    { id:"q18", dom:"D", text:"속쓰림/메스꺼움/역류 느낌이 자주 있다." },
    { id:"q19", dom:"D", text:"대변이 불규칙하다(변비/설사/묽음/토끼똥/잔변감 등)." },
    { id:"q20", dom:"D", text:"식후 졸림/멍함이 뚜렷하거나, 식사 후 컨디션이 확 떨어진다." },

    // THERMO / SWEAT / SENSORY (T)
    { id:"q21", dom:"T", text:"손발이 유난히 차거나(혹은 뜨거워서) 불편하다." },
    { id:"q22", dom:"T", text:"땀이 비정상적이다(식은땀/이유 없는 땀/땀이 거의 안 남 등)." },
    { id:"q23", dom:"T", text:"온도/날씨 변화에 유난히 민감해서 증상이 흔들린다." },
    { id:"q24", dom:"T", text:"소리/빛/냄새에 예민해져 피로가 빨리 오거나 컨디션이 무너진다." },

    // STRESS LINK (X)
    { id:"q25", dom:"X", text:"스트레스가 올라가면 증상이 확 악화되고, 안정되면 확실히 완화된다." },
  ];

  // ✅ 문항 렌더링 (모바일 가독성: 문항 간격 + 옵션 세로)
  const qWrap = document.getElementById("questions");
  qWrap.innerHTML = ITEMS.map((it, idx) => {
    const name = it.id;
    const opts = LIKERT.map(o => `
      <label class="opt">
        <input type="radio" name="${name}" value="${o.value}">
        <span>${o.label}</span>
      </label>
    `).join("");
    return `
      <div class="q" data-dom="${it.dom}">
        <div class="q-title">${idx+1}. ${it.text}</div>
        <div class="options">${opts}</div>
      </div>
    `;
  }).join("");

  function getSelectedValue(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? Number(el.value) : null;
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  // ✅ 점수 → 등급 라벨
  function labelForScore(score){
    // 0~100
    if(score >= 75) return "RED (상위 위험군)";
    if(score >= 50) return "ORANGE (고위험군)";
    if(score >= 25) return "YELLOW (주의군)";
    return "GREEN (안정군)";
  }

  // ✅ “코드” 생성 (너무 길게 안 가게: 도메인 합계만)
  function makeCode(domSum){
    // 예: A18|D12|S9|P14|T16|E6|X3
    const keys = Object.keys(domSum).sort();
    return keys.map(k => `${k}${domSum[k]}`).join("|");
  }

  function buildResultText(payload){
    const { score, label, code, domSum, refs } = payload;

    const lines = [];
    lines.push(`[BNI 1차 지수 결과]`);
    lines.push(`- 점수: ${score}/100`);
    lines.push(`- 등급: ${label}`);
    lines.push(`- 코드: ${code}`);
    lines.push(``);
    lines.push(`[도메인 합계(참고)]`);
    lines.push(`- P(통증/근골격): ${domSum.P || 0}`);
    lines.push(`- A(자율/신경): ${domSum.A || 0}`);
    lines.push(`- E(피로/에너지): ${domSum.E || 0}`);
    lines.push(`- S(수면): ${domSum.S || 0}`);
    lines.push(`- D(소화): ${domSum.D || 0}`);
    lines.push(`- T(체온/땀/감각): ${domSum.T || 0}`);
    lines.push(`- X(스트레스 연동): ${domSum.X || 0}`);
    lines.push(``);
    lines.push(`[참고 응답(비점수)]`);
    lines.push(`- 검사 경험: ${refs.imaging || ""}`);
    lines.push(`- “큰 이상 없음” 설명: ${refs.normal || ""}`);
    lines.push(`- 약 복용: ${refs.meds || ""}`);
    lines.push(``);
    lines.push(`[다음 단계]`);
    lines.push(`- 정밀 문진(m2)으로 넘어가면, 필요한 섹션이 자동으로 열립니다.`);
    lines.push(`- 아래 링크를 눌러 진행하세요.`);
    lines.push(payload.m2_url);

    return lines.join("\n");
  }

  // ✅ m2 링크 생성 (원장님 경로 기준)
  function makeM2Url(score, label, code){
    // 같은 repo 기준: herbmed0/m2.html
    const base = "https://bodyallhani.github.io/herbmed0/m2.html";
    const qs = new URLSearchParams({
      bni_score: String(score),
      bni_label: label,
      bni_code: code
    });
    return base + "?" + qs.toString();
  }

  document.getElementById("calcBtn").addEventListener("click", () => {
    // 1) 25문항 모두 체크 확인
    let missing = 0;
    const values = {};
    for(const it of ITEMS){
      const v = getSelectedValue(it.id);
      if(v === null) missing++;
      values[it.id] = v;
    }

    const warn = document.getElementById("warnText");
    if(missing > 0){
      warn.style.display = "block";
      document.getElementById("result").textContent =
        `아직 ${missing}개 문항이 비어있습니다.\n빈 문항을 채운 뒤 다시 계산하세요.`;
      return;
    }
    warn.style.display = "none";

    // 2) 총점 (0~100)
    // 25문항 × 0~4 = 최대 100
    let total = 0;
    const domSum = {};
    ITEMS.forEach(it => {
      const val = values[it.id];
      total += val;
      domSum[it.dom] = (domSum[it.dom] || 0) + val;
    });

    total = clamp(total, 0, 100);
    const label = labelForScore(total);
    const code = makeCode(domSum);

    // 3) 참고 응답(비점수)
    const refs = {
      imaging: document.getElementById("ref_imaging").value,
      normal: document.getElementById("ref_normal").value,
      meds: document.getElementById("ref_meds").value
    };

    // 4) m2 링크 + 저장
    const m2_url = makeM2Url(total, label, code);

    const payload = { score: total, label, code, domSum, refs, m2_url };

    // ✅ m2에서 읽도록 localStorage 저장 (m2에서 이미 BNI_PAYLOAD 읽는 구조였음)
    try{
      localStorage.setItem("BNI_PAYLOAD", JSON.stringify({
        score: total, label, code, domSum
      }));
    }catch(e){}

    const text = buildResultText(payload);
    document.getElementById("result").textContent = text;

    // ✅ 계산 직후: 사용자가 바로 누를 수 있게 링크 클릭 유도(자동 이동은 안 함)
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    // 라디오 초기화
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
    document.getElementById("ref_imaging").value = "";
    document.getElementById("ref_normal").value = "";
    document.getElementById("ref_meds").value = "";
    document.getElementById("warnText").style.display = "none";
    document.getElementById("result").textContent = "아직 계산 전입니다.";
    try{ localStorage.removeItem("BNI_PAYLOAD"); }catch(e){}
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  function copyText(text){
    const temp = document.createElement("textarea");
    temp.style.position = "fixed";
    temp.style.opacity = "0";
    temp.value = text;
    document.body.appendChild(temp);
    temp.focus();
    temp.select();
    try{ document.execCommand("copy"); }
    catch(e){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(()=>{});
      }
    }
    document.body.removeChild(temp);
  }

  document.getElementById("copyBtn").addEventListener("click", () => {
    const t = document.getElementById("result").textContent || "";
    if(!t || t.includes("아직 계산 전")) {
      alert("먼저 점수 계산을 해주세요.");
      return;
    }
    copyText(t);
    alert("결과가 복사되었습니다.");
  });
</script>
</body>
</html>
